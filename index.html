<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.7"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            background: #f5f5f5;
            min-height: 100vh;
        }

        .screen {
            display: none;
            height: 100vh;
            overflow: hidden;
        }

        .screen.active {
            display: block;
        }

        .auth-screen {
            background: #fff;
            padding: 40px 20px;
        }

        .auth-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 40px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .auth-logo h1 {
            font-size: 32px;
            color: #000;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .input-group input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
        }

        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        .auth-button {
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }

        .auth-button.primary {
            background: #000;
            color: white;
        }

        .auth-button.secondary {
            background: #f5f5f5;
            color: #000;
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #666;
        }

        .auth-switch a {
            color: #000;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }

        .chat-header {
            background: #000;
            color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #333;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 16px;
        }

        .auth-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .header-actions {
            display: flex;
            gap: 20px;
        }

        .header-button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 20px;
        }

        .messages-container {
            margin-top: 70px;
            height: calc(100vh - 140px);
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 65%;
            padding: 12px 16px;
            border-radius: 12px;
            margin: 5px 0;
        }

        .message.sent {
            background: #000;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.received {
            background: white;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .input-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 16px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 12px;
        }

        .message-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 24px;
            outline: none;
            font-size: 15px;
        }

        .send-button {
            background: #000;
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .users-screen {
            background: #fff;
        }

        .users-header {
            background: #000;
            color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .users-list {
            padding: 16px;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .user-item:hover {
            background: #f5f5f5;
        }

        .profile-screen {
            background: #fff;
        }

        .profile-header {
            background: #000;
            color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .profile-content {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 20px auto;
            position: relative;
            cursor: pointer;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .avatar-upload {
            position: absolute;
            bottom: 0;
            right: 0;
            background: #000;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
        }

        #imageInput {
            display: none;
        }
    </style>
</head>

<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="screen auth-screen">
        <div class="auth-container">
            <div class="auth-logo">
                <h1>Chat App</h1>
            </div>
            <div class="auth-form">
                <div class="input-group">
                    <label for="emailInput">Email address</label>
                    <input type="email" id="emailInput" placeholder="Enter your email">
                </div>
                <div class="input-group">
                    <label for="passwordInput">Password</label>
                    <input type="password" id="passwordInput" placeholder="Enter your password">
                </div>
                <div class="auth-buttons">
                    <button id="loginButton" class="auth-button primary">Sign In</button>
                    <button id="registerButton" class="auth-button secondary">Create Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Screen -->
    <div id="chatScreen" class="screen">
        <div class="chat-header">
            <div class="chat-user-info">
                <div class="avatar" id="chatUserAvatar">?</div>
                <span id="chatUserName">You (Myself)</span>
            </div>
            <div class="header-actions">
                <button class="header-button" onclick="showUsers()">
                    <i class="fas fa-users"></i>
                </button>
                <button class="header-button" onclick="showProfile()">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
        <div class="messages-container" id="messagesContainer"></div>
        <div class="input-area">
            <input type="text" class="message-input" id="messageInput" placeholder="Type a message...">
            <button class="send-button" id="sendButton">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Users Screen -->
    <div id="usersScreen" class="screen users-screen">
        <div class="users-header">
            <h2>All Users</h2>
            <button class="header-button" onclick="showChat()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="users-list" id="usersList"></div>
    </div>

    <!-- Profile Screen -->
    <div id="profileScreen" class="screen profile-screen">
        <div class="profile-header">
            <h2>Profile</h2>
            <button class="header-button" onclick="showChat()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="profile-content">
            <div class="profile-avatar" onclick="document.getElementById('imageInput').click()">
                <img id="profileImage" src="/api/placeholder/120/120" alt="Profile">
                <div class="avatar-upload">
                    <i class="fas fa-camera"></i>
                </div>
            </div>
            <input type="file" id="imageInput" accept="image/*">
        </div>
    </div>

    <script>
        console.log('Initializing app...');
        // Initialize Supabase Client
        const supabaseUrl = 'https://ugqokfdfjlatstubcqzj.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVncW9rZmRmamxhdHN0dWJjcXpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI4ODE0MDQsImV4cCI6MjA0ODQ1NzQwNH0.D4vXekLD3QB1dwu0zhbW9iqAnwMnC4_l9ldkJjYoXxo';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        console.log('Supabase initialized:', supabase);

        // DOM Elements
        const screens = {
            auth: document.getElementById('authScreen'),
            chat: document.getElementById('chatScreen'),
            users: document.getElementById('usersScreen'),
            profile: document.getElementById('profileScreen')
        };

        const elements = {
            emailInput: document.getElementById('emailInput'),
            passwordInput: document.getElementById('passwordInput'),
            loginButton: document.getElementById('loginButton'),
            registerButton: document.getElementById('registerButton'),
            messageInput: document.getElementById('messageInput'),
            sendButton: document.getElementById('sendButton'),
            messagesContainer: document.getElementById('messagesContainer'),
            usersList: document.getElementById('usersList'),
            chatUserAvatar: document.getElementById('chatUserAvatar'),
            chatUserName: document.getElementById('chatUserName'),
            profileImage: document.getElementById('profileImage'),
            imageInput: document.getElementById('imageInput')
        };

        // Global State
        let currentUser = null;
        let selectedUser = null;
        let messageSubscription = null;

        // Screen Management
        function showScreen(screenId) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            screens[screenId].classList.add('active');
        }

        function showAuth() {
            console.log('Showing auth screen');
            showScreen('auth');
        } function showChat() { showScreen('chat'); }
        function showUsers() { showScreen('users'); }
        function showProfile() { showScreen('profile'); }

        // Authentication Handlers
        elements.loginButton.addEventListener('click', async () => {
            const email = elements.emailInput.value;
            const password = elements.passwordInput.value;

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                if (error) throw error;
            } catch (error) {
                alert(error.message);
            }
        });



        // Auth State Observer
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (session) {
                currentUser = session.user;
                await loadUserProfile();
                await loadUsers();
                setupMessaging();
                showChat();
            } else {
                currentUser = null;
                if (messageSubscription) {
                    messageSubscription.unsubscribe();
                }
                showAuth();
            }
        });

        // Profile Management
        async function loadUserProfile() {
            try {
                const { data: profile, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error) throw error;

                if (profile) {
                    elements.chatUserName.textContent = `${profile.name} (Myself)`;
                    elements.chatUserAvatar.textContent = getAvatarLetter(profile.email);
                    if (profile.photo_url) {
                        elements.profileImage.src = profile.photo_url;
                        elements.chatUserAvatar.innerHTML = `<img src="${profile.photo_url}" alt="Profile" style="width: 40px; height: 40px; border-radius:50%;">`;
                    }
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                alert('Error loading profile: ' + error.message);
            }
        }

        elements.registerButton.innerHTML = '<span class="spinner"></span>Creating Account';

        elements.registerButton.addEventListener('click', async () => {
            const email = elements.emailInput.value;
            const password = elements.passwordInput.value;

            // Input validation
            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }

            // Disable button during signup
            elements.registerButton.disabled = true;
            elements.registerButton.textContent = 'Creating Account...';

            try {
                console.log('Starting signup process...');

                // First sign up with auth
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            name: email.split('@')[0]
                        }
                    }
                });
                console.log('Auth signup response:', authData);

                if (authError) throw authError;

                if (authData.user) {
                    // Check if email confirmation is required
                    if (authData.session === null) {
                        alert('Please check your email for confirmation link to complete registration!');
                        elements.registerButton.textContent = 'Check Email to Confirm';
                        return;
                    }

                    console.log('User created, inserting profile...');

                    const { data: userData, error: userError } = await supabase
                        .from('users')
                        .insert([{
                            id: authData.user.id,
                            email: email,
                            name: email.split('@')[0],
                        }]);

                    if (userError) {
                        console.error('User insert error:', userError);
                        // If insert fails, still show confirmation message if needed
                        if (!authData.session) {
                            alert('Please check your email for confirmation link to complete registration!');
                            return;
                        }
                        throw userError;
                    }

                    console.log('Profile created successfully:', userData);

                    if (!authData.session) {
                        alert('Please check your email for confirmation link to complete registration!');
                    }
                } else {
                    throw new Error('No user data returned from signup');
                }
            } catch (error) {
                console.error('Signup error:', error);
                alert(error.message);
            } finally {
                // Reset button state
                elements.registerButton.disabled = false;
                elements.registerButton.textContent = 'Create Account';
            }
        });

        // Image Upload
        elements.imageInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                // Show loading state
                elements.profileImage.src = '/api/placeholder/120/120';

                // Upload file to Supabase Storage
                const fileExt = file.name.split('.').pop();
                const fileName = `${currentUser.id}/${Date.now()}.${fileExt}`;
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('profile-images')
                    .upload(fileName, file);

                if (uploadError) throw uploadError;

                // Get public URL
                const { data: { publicUrl } } = supabase.storage
                    .from('profile-images')
                    .getPublicUrl(fileName);

                // Update profile in database
                const { error: updateError } = await supabase
                    .from('users')
                    .update({ photo_url: publicUrl })
                    .eq('id', currentUser.id);

                if (updateError) throw updateError;

                // Update UI
                elements.profileImage.src = publicUrl;
                if (!selectedUser) {
                    elements.chatUserAvatar.innerHTML = `<img src="${publicUrl}" alt="Profile" style="width: 40px; height: 40px; border-radius: 50%;">`;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error uploading image: ' + error.message);
                elements.profileImage.src = '/api/placeholder/120/120';
            }
        });

        // Users Management
        async function loadUsers() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .neq('id', currentUser.id);

                if (error) throw error;

                elements.usersList.innerHTML = '';
                users.forEach(user => {
                    const userElement = createUserElement(user);
                    elements.usersList.appendChild(userElement);
                });
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Error loading users: ' + error.message);
            }
        }

        function createUserElement(user) {
            const div = document.createElement('div');
            div.className = 'user-item';
            div.innerHTML = `
                <div class="avatar">
                    ${user.photo_url ?
                    `<img src="${user.photo_url}" alt="${user.name}" style="width: 40px; height: 40px; border-radius: 50%;">` :
                    getAvatarLetter(user.email)}
                </div>
                <span class="profile-name">${user.name}</span>
            `;
            div.addEventListener('click', () => {
                selectUser(user);
                showChat();
            });
            return div;
        }

        // Chat Management
        function selectUser(user) {
            selectedUser = user;
            elements.chatUserName.textContent = user.name;
            elements.chatUserAvatar.textContent = getAvatarLetter(user.email);
            if (user.photo_url) {
                elements.chatUserAvatar.innerHTML = `<img src="${user.photo_url}" alt="${user.name}" style="width: 40px; height: 40px; border-radius: 50%;">`;
            }
            loadMessages();
        }

        function setupMessaging() {
            elements.sendButton.addEventListener('click', sendMessage);
            elements.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
        }

        async function sendMessage() {
            if (!selectedUser || !elements.messageInput.value.trim()) return;

            try {
                const message = {
                    chat_id: getChatId(currentUser.id, selectedUser.id),
                    sender_id: currentUser.id,
                    text: elements.messageInput.value.trim(),
                };

                const { error } = await supabase
                    .from('messages')
                    .insert([message]);

                if (error) throw error;
                elements.messageInput.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Error sending message: ' + error.message);
            }
        }

        async function loadMessages() {
            // Unsubscribe from previous subscription if exists
            if (messageSubscription) {
                messageSubscription.unsubscribe();
            }

            const chatId = getChatId(currentUser.id, selectedUser.id);
            elements.messagesContainer.innerHTML = '';

            try {
                // Load existing messages
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .eq('chat_id', chatId)
                    .order('created_at', { ascending: true });

                if (error) throw error;

                messages.forEach(message => {
                    const messageElement = createMessageElement(message);
                    elements.messagesContainer.appendChild(messageElement);
                });

                elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;

                // Subscribe to new messages
                messageSubscription = supabase
                    .channel('messages')
                    .on('postgres_changes',
                        {
                            event: 'INSERT',
                            schema: 'public',
                            table: 'messages',
                            filter: `chat_id=eq.${chatId}`
                        },
                        payload => {
                            const messageElement = createMessageElement(payload.new);
                            elements.messagesContainer.appendChild(messageElement);
                            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
                        }
                    )
                    .subscribe();

            } catch (error) {
                console.error('Error loading messages:', error);
                alert('Error loading messages: ' + error.message);
            }
        }

        function createMessageElement(message) {
            const div = document.createElement('div');
            div.className = `message ${message.sender_id === currentUser.id ? 'sent' : 'received'}`;
            div.textContent = message.text;
            return div;
        }

        // Utility Functions
        function getAvatarLetter(email) {
            return email ? email[0].toUpperCase() : '?';
        }

        function getChatId(uid1, uid2) {
            return uid1 < uid2 ? `${uid1}-${uid2}` : `${uid2}-${uid1}`;
        }

        supabase.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                currentUser = session.user;
                loadUserProfile();
                loadUsers();
                setupMessaging();
                showChat();
            } else {
                showAuth();
            }
        });
        // Show initial screen
        showAuth();
    </script>
</body>

</html>